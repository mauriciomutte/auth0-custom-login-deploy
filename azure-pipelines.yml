# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  pnpm_config_cache: $(Pipeline.Workspace)/.pnpm-store

stages:
  - stage: build
    jobs:
      - job: Build
        displayName: Build
        steps:
          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(pnpm_config_cache)
            displayName: Cache pnpm

          - script: |
              curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm@7
              pnpm config set store-dir $(pnpm_config_cache)
            displayName: "Setup pnpm"
          - script: |
              pnpm install
              pnpm run build
            displayName: "pnpm install and build"
          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)'
              Contents: |
                **/**
                !**/node_modules/**
              TargetFolder: '$(build.artifactstagingdirectory)'
          - task: PublishBuildArtifacts@1
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(build.artifactstagingdirectory)'
              ArtifactName: 'drop'

  - stage: upload_static_files
    dependsOn: build
    condition: |
      in(dependencies.build.result, 'Succeeded', 'SucceededWithIssues')
    jobs:
      - job: upload_static_files
        displayName: Upload static files
        steps:
          - checkout: none
          - download: current
            artifact: drop
          - task: S3Upload@1
            inputs:
              awsCredentials: 'AWS Pipes'
              regionName: 'us-east-1'
              bucketName: 'dev-mutte0-idp'
              sourceFolder: '$(Pipeline.Workspace)/drop/out'
              globExpressions: '_next/**'
              filesAcl: 'public-read'

  - stage: deploy_prd
    dependsOn: upload_static_files
    condition: |
      in(dependencies.upload_static_files.result, 'Succeeded', 'SucceededWithIssues')
    jobs:
      - deployment: Deploy
        environment: "prd"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: none
                - task: NodeTool@0
                  displayName: "Use Node 16.x"
                  inputs:
                    versionSpec: '16.x'
                - script: |
                    curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm@7
                    pnpm config set store-dir $(pnpm_config_cache)
                  displayName: "Setup pnpm"
                - script: "cd $(Pipeline.Workspace)/drop && pnpm deploy:auth0"
                  displayName: "Deploy HTML in Auth0"
                  env:
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)"
                  