# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  pnpm_config_cache: $(Pipeline.Workspace)/.pnpm-store

stages:
  - stage: build
    jobs:
      - job: Build
        displayName: Build
        steps:
          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(pnpm_config_cache)
            displayName: Cache pnpm

          - script: |
              curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm@7
              pnpm config set store-dir $(pnpm_config_cache)
            displayName: "Setup pnpm"
          - script: |
              pnpm install
              pnpm run build
            displayName: "pnpm install and build"
          - task: CopyFiles@2
            displayName: 'Copy files'
            inputs:
              contents: 'out/**'
              targetFolder: '$(Build.BinariesDirectory)/app'
          - task: PublishBuildArtifacts@1
            displayName: "Publish Artifact app files"
            inputs:
              PathtoPublish: "$(Build.BinariesDirectory)/app"
            condition: succeededOrFailed()

  - stage: upload_static_files
    dependsOn: build
    jobs:
      - job: upload_static_files
        displayName: Upload static files
        steps:
          - task: S3Upload@1
            inputs:
              awsCredentials: 'AWS Pipes'
              regionName: 'us-east-1'
              bucketName: 'dev-mutte0-idp'
              sourceFolder: '$(Build.SourcesDirectory)/out'
              globExpressions: '_next/**'
              filesAcl: 'public-read'

  - stage: deploy_prd
    jobs:
      - deployment: Deploy
        environment: "prd"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: none
                - task: NodeTool@0
                  displayName: "Use Node 16.x"
                  inputs:
                    versionSpec: '16.x'